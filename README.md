# 勤怠管理システム

## 概要

この勤怠管理システムは、従業員の出勤・退勤・休憩時間を記録・管理するためのWebアプリケーションです。

## 機能

### 基本機能
- **ユーザー認証**: ログイン・新規ユーザー登録
- **勤怠記録**: 出勤、退勤、休憩開始、休憩終了の記録
- **リアルタイム表示**: 現在時刻と勤務状況の表示
- **勤怠履歴**: 過去の勤怠記録の閲覧・検索
- **労働時間計算**: 自動的な労働時間の計算（休憩時間を除く）

### 管理者機能
- **ユーザー管理**: 全ユーザーの一覧表示・勤怠確認
- **勤怠修正**: 既存の勤怠記録の修正（時刻変更・メモ追加）
- **勤怠作成**: 従業員の代理で勤怠記録を作成
- **修正ログ**: 全ての修正・作成操作のログ記録
- **権限管理**: 管理者権限の付与・管理

### 技術仕様
- **バックエンド**: FastAPI + SQLAlchemy + SQLite
- **フロントエンド**: HTML5 + CSS3 + Vanilla JavaScript
- **認証**: JWT（JSON Web Token）
- **パスワード**: bcrypt によるハッシュ化

## セットアップ手順

### 1. 前提条件
- Python 3.8以上
- pip（Python パッケージマネージャー）

### 2. プロジェクトのクローンまたはダウンロード
```bash
git clone <repository-url>
cd attendance-tool
```

### 3. 仮想環境の作成（推奨）
```bash
python -m venv venv

# Windows
venv\\Scripts\\activate

# macOS/Linux
source venv/bin/activate
```

### 4. 依存関係のインストール
```bash
cd backend
pip install -r requirements.txt
```

### 5. データベースの初期化
アプリケーション初回起動時に、SQLiteデータベースファイル（attendance.db）が自動的に作成されます。

### 6. アプリケーションの起動

#### バックエンドサーバーの起動
```bash
cd backend
python main.py
```
または
```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

サーバーは `http://localhost:8000` で起動します。

#### フロントエンドの表示
1. ブラウザで `frontend/index.html` を開く
2. または、Python の HTTP サーバーを使用:
```bash
cd frontend
python -m http.server 3000
```
その後、`http://localhost:3000` にアクセス

## 使用方法

### 基本的な使用方法

#### 1. 新規ユーザー登録
1. 「新規登録はこちら」をクリック
2. 氏名、ユーザー名、メールアドレス、パスワードを入力
3. 「登録」ボタンをクリック

#### 2. ログイン
1. ユーザー名とパスワードを入力
2. 「ログイン」ボタンをクリック

#### 3. 勤怠記録
1. **出勤**: 「出勤」ボタンをクリック
2. **休憩開始**: 「休憩開始」ボタンをクリック
3. **休憩終了**: 「休憩終了」ボタンをクリック
4. **退勤**: 「退勤」ボタンをクリック

#### 4. 勤怠履歴の確認
- 履歴テーブルで過去の勤怠記録を確認
- 日付範囲を指定して検索可能
- 労働時間が自動計算されて表示

### 修正申請機能の使用方法（一般ユーザー）

#### 1. 既存記録の修正申請
1. 勤怠履歴テーブルの「修正申請」ボタンをクリック
2. 修正したい時刻を入力
3. 申請理由を入力（必須）
4. 「申請する」ボタンをクリック

#### 2. 新規記録の申請
1. 修正申請履歴の「新規申請」ボタンをクリック
2. 対象日付と時刻を入力
3. 申請理由を入力（必須）
4. 「申請する」ボタンをクリック

#### 3. 申請状況の確認
- 修正申請履歴テーブルで申請状況を確認
- 承認待ち・承認済み・却下の状態を表示
- 管理者からのコメントも確認可能

### 管理者機能の使用方法

#### 1. 管理者でログイン
- 管理者権限を持つユーザーでログイン
- ヘッダーに「管理者メニュー」ボタンが表示される

#### 2. 修正申請の承認・却下
- 管理者メニューの「修正申請の管理」で全申請を確認
- 「処理」ボタンで申請詳細を確認
- 管理者コメントを入力して「承認」または「却下」

#### 3. ユーザー管理
- 全ユーザーの一覧表示
- 「勤怠確認」ボタンで個別ユーザーの勤怠履歴を表示

#### 4. 緊急時の直接修正
- **修正の場合**:
  1. 対象ユーザーと日付を選択
  2. 「既存記録を読み込み」をクリック
  3. 時刻を修正し、修正理由を入力
  4. 「修正実行」をクリック
- **新規作成の場合**:
  1. 対象ユーザーと日付を選択
  2. 必要な時刻を入力し、作成理由を入力
  3. 「新規作成」をクリック

#### 5. 完全なログ管理
- 全ての修正・承認操作は自動的にログが記録される
- メモ欄に操作者と理由が追記される

## API エンドポイント

### 認証関連
- `POST /register` - 新規ユーザー登録
- `POST /login` - ログイン

### 勤怠関連
- `POST /attendance` - 勤怠記録（出勤・退勤・休憩）
- `GET /attendance` - 勤怠履歴取得
- `GET /attendance/today` - 今日の勤怠状況取得

### 修正申請API
- `POST /correction-request` - 修正申請作成
- `GET /correction-requests` - 自分の修正申請履歴取得

### 管理者専用API
- `GET /admin/users` - 全ユーザー一覧取得
- `GET /admin/attendance/{user_id}` - 指定ユーザーの勤怠履歴取得
- `PUT /admin/attendance/{record_id}` - 勤怠記録修正（直接修正）
- `POST /admin/attendance/create` - 勤怠記録作成（直接作成）
- `GET /admin/correction-requests` - 全修正申請一覧取得
- `PUT /admin/correction-requests/{request_id}` - 修正申請の承認・却下

## ディレクトリ構造

```
attendance-tool/
├── backend/
│   ├── main.py              # FastAPI アプリケーション
│   ├── create_admin.py      # 管理者ユーザー管理ツール
│   ├── create_simple_admin.py  # シンプルな管理者作成
│   ├── requirements.txt     # Python 依存関係
│   └── attendance.db        # SQLite データベース（自動生成）
├── frontend/
│   ├── index.html           # メインHTML
│   ├── styles.css           # スタイルシート
│   └── app.js               # JavaScript
└── README.md
```

## セキュリティ機能

- パスワードのbcryptハッシュ化
- JWT トークンによる認証
- CORS対応
- SQLインジェクション対策（SQLAlchemy ORM使用）

## カスタマイズ

### JWT秘密鍵の変更
`backend/main.py` の `SECRET_KEY` を変更してください：
```python
SECRET_KEY = "your-new-secret-key-here"
```

### データベースの変更
SQLite以外のデータベースを使用する場合は、`DATABASE_URL` を変更してください：
```python
DATABASE_URL = "postgresql://user:password@host:port/database"
```

## トラブルシューティング

### よくある問題と解決方法

1. **「モジュールが見つかりません」エラー**
   - 仮想環境がアクティベートされているか確認
   - `pip install -r requirements.txt` を再実行

2. **CORS エラー**
   - フロントエンドとバックエンドが異なるポートで動作していることを確認
   - ブラウザのコンソールでエラー内容を確認

3. **データベースエラー**
   - `attendance.db` ファイルの権限を確認
   - 必要に応じてファイルを削除して再作成

4. **ログインできない**
   - ユーザー名とパスワードが正しいか確認
   - 新規登録が正常に完了しているか確認

## 管理者ユーザーの作成

初回セットアップ時に管理者ユーザーを作成する必要があります。

### 方法1: シンプル作成スクリプト
```bash
cd backend
python create_simple_admin.py
```
デフォルトの管理者ユーザーが作成されます：
- ユーザー名: `admin`
- パスワード: `admin123`
- 氏名: システム管理者

### 方法2: インタラクティブ作成ツール
```bash
cd backend
python create_admin.py
```
対話式で管理者ユーザーを作成できます。

## 今後の拡張予定

- 勤怠データのCSVエクスポート
- メール通知機能
- 休暇申請機能
- シフト管理機能
- 承認ワークフロー

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。